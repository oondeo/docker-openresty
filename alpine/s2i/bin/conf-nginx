#!/bin/bash


while IFS='=' read -r name value ; do
  if [[ $name == 'NGINXCONF_'* ]]; then
    name="${name/NGINXCONF_/}"
    name="${name,,}"
    name="${name/__/\.}"
    for f in $(find /etc/nginx/ -type f -not -path "/etc/nginx/naxsi*" 2> /dev/null)
    do 
      if [ "$value" != "" ]
      then
        sed -i "/$name .*/$name ${value//\//\\/};/g" $f
        echo " " >> $f
      else
        sed -i "/$name[ =].*/d" $f
      fi
    done
  fi
done < <(env)

# if [ ! -f $filename ]
# then 
#   exit 0
# fi

HOME=${HOME:-"/opt/app-root/src/webroot"}
DOMAIN_PROD=${DOMAIN_PROD:-nginx.dev.oondeo.es}
DOMAIN_DEV=${DOMAIN_DEV:-nginx.dev.oondeo.es}
NGINX_CACHE=${NGINX_CACHE:-0}
for filename in $(find /etc/nginx/ -type f -not -path "/etc/nginx/naxsi*" 2> /dev/null); do
  sed -i "s/{{HOME}}/${HOME//\//\\/}/g" $filename
  sed -i "s/{{DOMAIN_PROD}}/$DOMAIN_PROD/g" $filename
  sed -i "s/{{DOMAIN_DEV}}/$DOMAIN_DEV/g" $filename
  if [ "$NGINX_CACHE" == "1" ] || [ "$NGINX_CACHE" == "true" ] || [ "$NGINX_CACHE" == "TRUE" ]
  then
    sed -i 's/{{NGINX_CACHE}}//g' $filename
  else
    sed -i 's/{{NGINX_CACHE}}/set \$no_cache "1";/g' $filename
  fi
done

